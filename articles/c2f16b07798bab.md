# はじめに

Neovim には組み込みの[LSP](https://microsoft.github.io/language-server-protocol/)クライアントがあります。ちょっと前までは VSCode 並の開発体験のためには coc を使うのがベストな選択肢でしたが、neovim builtin lsp(以下 nvim-lsp)でもエコシステムが整ってきており、かなりいい感じの支援機能が受けられます。この記事ではその設定などについて書いていこうと思います。

# 環境

- Linux (Windows だと後述の lspinstall というプラグインが使えないのでおすすめできません。LSP を使うこと自体はできます。)
  ※Windows で使いたいひとは下の[追記](#追記)を参照してください。
- Neovim 0.5
- Vimscript は使わず Lua で書きます

# 基本的な設定

## 必須プラグイン系

nvim-lsp は組み込みではあるものの、そのままだと扱いづらいため実質必須となるプラグインがあります。

- nvim-lspconfig (https://github.com/neovim/nvim-lspconfig)
- nvim-lspinstall (https://github.com/kabouzeid/nvim-lspinstall/)

まず、各言語用の設定を提供する[nvim-lspconfig](https://github.com/neovim/nvim-lspconfig)です。neovim の公式で管理されています。

また、nvim-lsp はあくまで「クライアント」なので各言語用のサーバーも必要になります。これを neovim 内からインストールできるようにするプラグインが nvim-lspinstall です。前述の通り、このプラグインは Linux のみ対応です。一応 Windows 対応の PR は出ていますがマージされるかは分かりません。

次のコードは設定例です。といってもほぼ README からのコピペです。

```lua:lua/init.lua
require('packer').startup(function()
  use 'wbthomason/packer.nvim'
  use 'neovim/nvim-lspconfig'
  use {'kabouzeid/nvim-lspinstall',
    config = function ()
      require 'lsp'
    end
  }
end)
vim.cmd([[autocmd BufWritePost init.lua source <afile> | PackerCompile]])
```

```lua:lsp.lua
-- Use an on_attach function to only map the following keys
-- after the language server attaches to the current buffer
local on_attach = function(client, bufnr)
  local function buf_set_keymap(...) vim.api.nvim_buf_set_keymap(bufnr, ...) end
  local function buf_set_option(...) vim.api.nvim_buf_set_option(bufnr, ...) end
  --Enable completion triggered by <c-x><c-o>
  buf_set_option('omnifunc', 'v:lua.vim.lsp.omnifunc')
  -- Mappings.
  local opts = { noremap=true, silent=true }
  -- See `:help vim.lsp.*` for documentation on any of the below functions
  buf_set_keymap('n', 'gD', '<cmd>lua vim.lsp.buf.declaration()<CR>', opts)
  buf_set_keymap('n', 'gd', '<cmd>lua vim.lsp.buf.definition()<CR>', opts)
  buf_set_keymap('n', 'K', '<cmd>lua vim.lsp.buf.hover()<CR>', opts)
  buf_set_keymap('n', 'gi', '<cmd>lua vim.lsp.buf.implementation()<CR>', opts)
  buf_set_keymap('n', '<C-k>', '<cmd>lua vim.lsp.buf.signature_help()<CR>', opts)
  buf_set_keymap('n', '<space>wa', '<cmd>lua vim.lsp.buf.add_workspace_folder()<CR>', opts)
  buf_set_keymap('n', '<space>wr', '<cmd>lua vim.lsp.buf.remove_workspace_folder()<CR>', opts)
  buf_set_keymap('n', '<space>wl', '<cmd>lua print(vim.inspect(vim.lsp.buf.list_workspace_folders()))<CR>', opts)
  buf_set_keymap('n', '<space>D', '<cmd>lua vim.lsp.buf.type_definition()<CR>', opts)
  buf_set_keymap('n', '<space>rn', '<cmd>lua vim.lsp.buf.rename()<CR>', opts)
  buf_set_keymap('n', '<space>ca', '<cmd>lua vim.lsp.buf.code_action()<CR>', opts)
  buf_set_keymap('n', 'gr', '<cmd>lua vim.lsp.buf.references()<CR>', opts)
  buf_set_keymap('n', '<space>e', '<cmd>lua vim.lsp.diagnostic.show_line_diagnostics()<CR>', opts)
  buf_set_keymap('n', '[d', '<cmd>lua vim.lsp.diagnostic.goto_prev()<CR>', opts)
  buf_set_keymap('n', ']d', '<cmd>lua vim.lsp.diagnostic.goto_next()<CR>', opts)
  buf_set_keymap('n', '<space>q', '<cmd>lua vim.lsp.diagnostic.set_loclist()<CR>', opts)
  buf_set_keymap('n', '<space>f', '<cmd>lua vim.lsp.buf.formatting()<CR>', opts)
end

local function setup_servers()
  require'lspinstall'.setup()
  local servers = require'lspinstall'.installed_servers()
  for _, server in pairs(servers) do
    require'lspconfig'[server].setup{
      on_attach = on_attach,
    }
  end
end

setup_servers()

-- Automatically reload after `:LspInstall <server>` so we don't have to restart neovim
require'lspinstall'.post_install_hook = function ()
  setup_servers() -- reload installed servers
  vim.cmd("bufdo e") -- this triggers the FileType autocmd that starts the server
end
```

ここでは[packer.nvim](wbthomason/packer.nvim)を使用しています。packer は Lua 製のパッケージマネージャで、config にそのまま Lua の関数が書けたりと Lua との親和性がとても高いです。完全に neovim に乗り換えるという人にはおすすめです。

こんな感じの設定を書き neovim を起動します。trouble`:LspInstall [server name]`というコマンドが使えるようになっています。
例えば`:LspInstall typescript`を実行してみます。そうすれば

```
Successfully installed language server for typescript
```

と出るはずです。これで`.ts`ファイルを開いたときなどにサーバーが起動するようになります。上の設定例では例えばノーマルモードで`K`でホバーを出したり、`gd`で定義に移動することができるようになります。
また、構文エラーのあるコードを書くとその旨が表示されます。

カラースキームなどを設定していない状態で上のように設定して`K`を押すとこのように気持ち悪い色のホバーが表示されます。
![](https://storage.googleapis.com/zenn-user-upload/46493524a2b62dcaa6ce741e.png)

:::message
ちなみに Typescript のサーバーである`typescript-language-server`は`node_modules`内にある`typescript`モジュールを内部で利用しているため、npm で typescript をインストールしておかないと使えません。グローバルにインストールしておけば自動でフォールバックされます。
:::

### 追記

今なら nvim-lspinstall の代わりに[nvim-lsp-installer](https://github.com/williamboman/nvim-lsp-installer)を使うのがよさそうです。windows にも対応していていい感じのインストール画面もあります。

ついでに宣伝ですが自分でも[installer.nvim](https://github.com/nazo6/installer.nvim)というプラグインを作ってみました。LSP だけではなく色々なツールをインストールできるのがウリです。

## 補完

さて、これで LSP 自体は動かせたわけですが、実はこのままだと補完が効きません。vim では他に補完プラグインを入れる必要があるからです。そして補完プラグインをいろいろ選べるのも vim のメリットの一つではありますが、実は LSP に対応した補完プラグインとなるとほぼ選択肢が二択で、[nvim-compe](https://github.com/hrsh7th/nvim-compe)か、後継プラグインである[nvim-cmp](https://github.com/hrsh7th/nvim-cmp)です。

~~ここでは一応 stable な nvim-compe を使いますが、nvim-cmp が正式版になり次第 nvim-compe は非推奨となるようなので今のうちから nvim-cmp を使うのもアリです。~~
とか書いた数日後に nvim-compe が非推奨になっていたので nvim-cmp を利用することをおすすめします

#### nvim-compe (deprecated)

```lua:init.lua
-- packerのstartup内に追加
use { "hrsh7th/nvim-compe",
  config = function()
    require("compe-settings")
  end
}
```

```lua:lua/compe-settings.lua
vim.o.completeopt = "menuone,noselect"

require'compe'.setup {
  enabled = true;
  autocomplete = true;
  debug = false;
  min_length = 1;
  preselect = 'enable';
  throttle_time = 80;
  source_timeout = 200;
  resolve_timeout = 800;
  incomplete_delay = 400;
  max_abbr_width = 100;
  max_kind_width = 100;
  max_menu_width = 100;
  source = {
    path = true;
    buffer = true;
    calc = true;
    nvim_lsp = true;
    nvim_lua = true;
  };
}

vim.cmd[[
inoremap <silent><expr> <C-Space> compe#complete()
inoremap <silent><expr> <CR>      compe#confirm('<CR>')
inoremap <silent><expr> <C-e>     compe#close('<C-e>')
inoremap <silent><expr> <C-f>     compe#scroll({ 'delta': +4 })
inoremap <silent><expr> <C-d>     compe#scroll({ 'delta': -4 })
]]
```

相変わらずカラースキームを適用していないので色がキモいですがこれでこんな感じに補完が出るようになりました！
![](https://storage.googleapis.com/zenn-user-upload/ce6191841f729ab200a2a14a.png)

### 他の補完プラグイン

LSP の対応具合は前述の通り compe/cmp が最強だと思われますが対応しているプラグインは他にもあるので紹介します

- ddc.vim

https://github.com/Shougo/ddc.vim

[denops.vim](https://github.com/vim-denops/denops.vim)を使った補完プラグインで、[nvim-lsp の source](https://github.com/Shougo/ddc-nvim-lsp)を入れれば nvim-lsp でも使えます。かの有名な`deoplete`の後継みたいです

- coq_nvim

https://github.com/ms-jpq/coq_nvim

coc.nvim に似ていますが別物です。最近できたプラグインで Python で書かれています。「クソ速い」補完プラグインらしいです。パッと見かなり高機能そうな感じがします。

- completion-nvim

https://github.com/nvim-lua/completion-nvim

使ったことはないのですが Reddit では非常に評判がよろしくないです。これを使ってる記事は古いものだという判断材料になるかもしれません。

# フォーマット

neovim でフォーマッタを動かす方法はいろいろありますが、ここでは[null-ls](https://github.com/jose-elias-alvarez/null-ls.nvim)を紹介します。
これは様々なツールの出力を LSP で読み込める形式に変換して neovim に送るという仕組みになっています。似たようなツールに[diagnostic-languageserver](https://github.com/iamcco/diagnostic-languageserver)や[efm-langserver](https://github.com/mattn/efm-langserver)がありますが、`null-ls`はあくまで neovim のプラグインに過ぎないので外部依存がないことが利点です。また様々なリンター／フォーマッタ用にあらかじめ設定が用意されているので簡単に設定できます。

これは Prettier の設定例です。あらかじめグローバルに`prettier`を npm でインストールしておく必要があります。

```lua:init.lua
-- "lsp.lua"が読みこまれるより前の位置に追加
use { "jose-elias-alvarez/null-ls.nvim", requires = { "nvim-lua/plenary.nvim" } }
```

```lua:lua/lsp.lua
-- 追記
local nullls = require "null-ls"
nullls.config {
  sources = {
    nullls.builtins.formatting.prettier,
  },
}
require("lspconfig")["null-ls"].setup {}
```

サーバーによってはそれ自体がフォーマット機能を持っているものがあります。それを無効化するには`lsp.lua`内の`on_attach`に

```lua
client.resolved_capabilities.document_formatting = false
```

を追加します。

https://github.com/jose-elias-alvarez/null-ls.nvim/blob/main/doc/BUILTINS.md

# いろいろなプラグイン達

ここまでで基本的には完了ですが、ここからは nvim-lsp と組み合わせて使える便利なプラグインを備忘録を兼ねて書いていきます。

## 拡張系

- lspsaga.nvim

https://github.com/glepnir/lspsaga.nvim
なんかいろいろリッチな表示になるプラグイン

- lsp_signature.nvim

https://github.com/ray-x/lsp_signature.nvim

VSCode でできる、関数を引数を入力しているときに表示してくれるやつです。

- lspkind-nvim

https://github.com/onsails/lspkind-nvim

補完にアイコンを追加してくれるやつ

- trouble.nvim

https://github.com/folke/trouble.nvim

VSCode の下部に出るエラー一覧みたいなやつです。超便利。

## 特定の言語系

nvim-lsp を利用した特定の言語やフレームワーク向けのプラグインも開発され始めています。

- flutter-tools.nvim

https://github.com/akinsho/flutter-tools.nvim

neovim で flutter を使うなら前は coc 一択だったと思いますがこのプラグインがあれば coc じゃなくてもいいかなと思えるプラグインです。

- nvim-lsp-ts-utils

https://github.com/jose-elias-alvarez/nvim-lsp-ts-utils

まだ使ってないですが結構便利そう。ローカルの Prettier とか ESLint を使うとかできるみたいです。

- rust-tools.nvim

https://github.com/simrat39/rust-tools.nvim

Rust です

- go.nvim

https://github.com/ray-x/go.nvim

Go です

- nvim-jdtls

https://github.com/mfussenegger/nvim-jdtls

Java です

# 参考になるサイト

- 公式の LSP のドキュメント

https://neovim.io/doc/user/lsp.html

とりあえず迷ったらここを見ましょう

- r/neovim

https://www.reddit.com/r/neovim/

海外の巨大掲示板 Reddit の neovim 板です。基本的に新しいプラグインはここで宣伝されています。他にもいろいろな neovim の最新情報を知ることができます。

# 最後に

一応設定をまとめた gist を作っておきました。`packer.nvim`をインストールすればこれだけで一応使えるようになっているはずです。多分。
https://gist.github.com/nazo6/f1d013e52250e21e56e08d19c757409d

ついでに自分の neovim の設定のリポジトリを置いておきます。よければ参考にしてください。
https://github.com/nazo6/nvim

それではよい neovim ライフを。
