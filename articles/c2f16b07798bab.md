---
title: Neovim builtin LSP設定入門
emoji: 📄
type: idea
topics: [lsp, neovim, lua]
published: true
---

# はじめに

Neovim には組み込みの[LSP](https://microsoft.github.io/language-server-protocol/)クライアントがあります。ちょっと前までは VSCode 並の開発体験を得るためには`coc.nvim`を使うのがベストな選択肢でしたが、neovim builtin lsp(以下 nvim-lsp)でもエコシステムが整ってきており、いい感じの支援機能が受けられます。この記事ではその設定の入門について説明します。

また、例としてWebフロント系のツールを使っています。わからなくても問題ありませんがわかってるとより理解しやすいかと思います。

# 環境

- Neovim 0.7 
- Vimscript は使わず Lua で書きます

# 基本的な設定

## 必須プラグイン系

nvim-lsp は組み込みではあるものの、そのままだと扱いづらいため実質必須となるプラグインがあります。

- nvim-lspconfig (https://github.com/neovim/nvim-lspconfig)
- nvim-lsp-installer (https://github.com/williamboman/nvim-lsp-installer)

まず、各言語用の設定を提供する[nvim-lspconfig](https://github.com/neovim/nvim-lspconfig)です。neovim の公式で管理されています。LSPプロトコル自体はどの言語でも共通ですがLSPサーバーを起動するためのコマンドラインオプションやどういう場合にどの言語サーバーを起動させるべきか(例えば`package.json`がある場合は Typescript の言語サーバーが起動してほしいなど)はそれぞれ違うのでこのプラグインが必要になります。

また、nvim-lsp はあくまでLSPクライアントなので各言語用のサーバーも必要になります。これを neovim 内からインストールできるようにするプラグインが nvim-lsp-installer です。OS 付属のパッケージマネジャー等でも LSP サーバをインストールすることは可能ですがこのプラグインを使うと既存の環境を汚さずにインストールすることができます。

次のコードは設定例です。

```lua :lua/init.lua
local install_path = vim.fn.stdpath("data").."/site/pack/packer/start/packer.nvim"
if vim.fn.empty(vim.fn.glob(install_path)) > 0 then
  packer_bootstrap = vim.fn.system({"git", "clone", "--depth", "1", "https://github.com/wbthomason/packer.nvim", install_path})
end

require("packer").startup(function(use)
  use "wbthomason/packer.nvim"
  use "neovim/nvim-lspconfig"
  use "williamboman/nvim-lsp-installer"

  if packer_bootstrap then
    require("packer").sync()
  end
end)
vim.cmd([[autocmd BufWritePost init.lua source <afile> | PackerCompile]])

local on_attach = function(client, bufnr)
  local function buf_set_keymap(...)
    vim.api.nvim_buf_set_keymap(bufnr, ...)
  end

  -- LSPサーバーのフォーマット機能を無効にする
  -- client.resolved_capabilities.document_formatting = false

  local opts = { noremap = true, silent = true }
  buf_set_keymap("n", "gD", "<cmd>lua vim.lsp.buf.declaration()<CR>", opts)
  buf_set_keymap("n", "gd", "<cmd>lua vim.lsp.buf.definition()<CR>", opts)
  buf_set_keymap("n", "K", "<cmd>lua vim.lsp.buf.hover()<CR>", opts)
  buf_set_keymap("n", "gi", "<cmd>lua vim.lsp.buf.implementation()<CR>", opts)
  buf_set_keymap("n", "<C-k>", "<cmd>lua vim.lsp.buf.signature_help()<CR>", opts)
  buf_set_keymap("n", "<space>wa", "<cmd>lua vim.lsp.buf.add_workspace_folder()<CR>", opts)
  buf_set_keymap("n", "<space>wr", "<cmd>lua vim.lsp.buf.remove_workspace_folder()<CR>", opts)
  buf_set_keymap("n", "<space>wl", "<cmd>lua print(vim.inspect(vim.lsp.buf.list_workspace_folders()))<CR>", opts)
  buf_set_keymap("n", "<space>D", "<cmd>lua vim.lsp.buf.type_definition()<CR>", opts)
  buf_set_keymap("n", "<space>rn", "<cmd>lua vim.lsp.buf.rename()<CR>", opts)
  buf_set_keymap("n", "<space>ca", "<cmd>lua vim.lsp.buf.code_action()<CR>", opts)
  buf_set_keymap("n", "gr", "<cmd>lua vim.lsp.buf.references()<CR>", opts)
  buf_set_keymap("n", "<space>e", "<cmd>lua vim.lsp.diagnostic.show_line_diagnostics()<CR>", opts)
  buf_set_keymap("n", "[d", "<cmd>lua vim.lsp.diagnostic.goto_prev()<CR>", opts)
  buf_set_keymap("n", "]d", "<cmd>lua vim.lsp.diagnostic.goto_next()<CR>", opts)
  buf_set_keymap("n", "<space>q", "<cmd>lua vim.lsp.diagnostic.set_loclist()<CR>", opts)
  buf_set_keymap("n", "<space>f", "<cmd>lua vim.lsp.buf.formatting()<CR>", opts)
end

local lsp_installer = require "nvim-lsp-installer"
local lspconfig = require "lspconfig"
lsp_installer.setup()
for _, server in ipairs(lsp_installer.get_installed_servers()) do
  lspconfig[server.name].setup {
    on_attach = on_attach,
  }
end
```

ここではプラグインマネージャとして[packer.nvim](wbthomason/packer.nvim)を使用しています。packer は Lua 製のパッケージマネージャで、config にそのまま Lua の関数が書けたりと Lua との親和性がとても高いです。完全に neovim に乗り換えるという人にはおすすめです。

この設定を書き neovim を起動すると、`:LspInstall [server name]`というコマンドが使えるようになっています。`server name`は、nvim-lspconfig の CONFIG.md に記載されているものと同等です。
例えば`:LspInstall tsserver`を実行すると、typescript の Language Server である`typescript-language-server`がインストールされます。
すると、`.ts`ファイルを開いたときにサーバーが起動するようになります。

さらに、`:LspInstallInfo`コマンドを使うことで下図のようにインタラクティブなサーバーインストール画面がでます。
![](/images/neovim-lsp/nvim-lsp-installer.png)

この設定例では`K`を押すとこのようにホバーが表示されます。
また、構文エラーのあるコードを書くとその旨が表示されるようになります。
![](/images/neovim-lsp/hover.png)
他にも`gd`で定義に移動などの機能が使えます。

:::message
ちなみに`typescript-language-server`は`typescript`モジュール付属の`tsserver`を内部で利用しているため、npm で typescript をインストールしておかないと使えません。グローバルにインストールしておけば自動でフォールバックされるみたいです。
:::

## 補完

これで LSP は動くようになりましたが、補完を行うには補完プラグインを入れる必要があります。Vim には様々な補完プラグインがありますが、LSP への対応度が高い[nvim-cmp](https://github.com/hrsh7th/nvim-cmp)がおすすめです。この記事ではこれを使用します。

本体と LSP 用の補完ソースが分離されているため、両方インストールします。nvim-lsp 以外にも様々な補完ソースが開発されおり、下のサンプルではバッファのキーワードを補完してくれる`cmp-buffer`を入れています。
他にもコマンドラインバッファの補完をしてくれる[cmp-cmdline](https://github.com/hrsh7th/cmp-cmdline)が非常に便利なのでおすすめです。

また、ここではスニペットプラグインとして、[vim-vsnip](github.com/hrsh7th/vim-vsnip)を使います。スニペットプラグインは実質的に必須なので何か入れておきましょう。

```lua :init.lua
-- packerのstartup内に追加
use "hrsh7th/nvim-cmp"
use "hrsh7th/cmp-nvim-lsp"
use "hrsh7th/cmp-vsnip"
use "hrsh7th/cmp-buffer"

use "hrsh7th/vim-vsnip"

-- lspconfig[server.name].setupに追加
capabilities = require("cmp_nvim_lsp").update_capabilities(vim.lsp.protocol.make_client_capabilities())

-- 最後に追加
vim.opt.completeopt = "menu,menuone,noselect"

local cmp = require"cmp"
cmp.setup({
  snippet = {
    expand = function(args)
      vim.fn["vsnip#anonymous"](args.body)
    end,
  },
  mapping = cmp.mapping.preset.insert({
    ["<C-d>"] = cmp.mapping.scroll_docs(-4),
    ["<C-f>"] = cmp.mapping.scroll_docs(4),
    ["<C-Space>"] = cmp.mapping.complete(),
    ["<C-e>"] = cmp.mapping.close(),
    ["<CR>"] = cmp.mapping.confirm({ select = true }),
  }),
  sources = cmp.config.sources({
    { name = "nvim_lsp" },
    { name = "vsnip" },
  }, {
    { name = "buffer" },
  })
})
```

これでこんな感じに補完が出るようになります。
![](/images/neovim-lsp/cmp.png)

### 他の補完プラグイン

LSP の対応具合は nvim-cmp が最強だと思われますが他にも nvim-lsp 対応のプラグインを紹介しておきます。

- ddc.vim

https://github.com/Shougo/ddc.vim

[denops.vim](https://github.com/vim-denops/denops.vim)を使った補完プラグインで、[nvim-lsp の source](https://github.com/Shougo/ddc-nvim-lsp)を入れれば nvim-lsp でも使えます。かの有名な`deoplete`の後継みたいです

- coq_nvim

https://github.com/ms-jpq/coq_nvim

coc.nvim に似ていますが別物です。Python 製ですが neovim 専用です。

# フォーマッタ/リンタ

ついでにフォーマッタ/リンタの設定もしてしまいます。
neovim でフォーマッタ/リンタを動かす方法はいろいろありますが、ここでは[null-ls](https://github.com/jose-elias-alvarez/null-ls.nvim)を紹介します。
これは様々なツールの出力を LSP の形式に変換して nvim-lsp に送るという仕組みになっています。似たようなツールに[diagnostic-languageserver](https://github.com/iamcco/diagnostic-languageserver)や[efm-langserver](https://github.com/mattn/efm-langserver)がありますが、`null-ls`はあくまで neovim のプラグインなので外部依存がないことが利点です。
また様々なリンター／フォーマッタ用にあらかじめ設定が用意されているので簡単に設定できます。
詳しくは[null-ls のドキュメント](https://github.com/jose-elias-alvarez/null-ls.nvim/blob/main/doc/BUILTINS.md)を見てください。

これは Prettier の設定例です。npmでローカルに`prettier`がインストールされていればそちらが、インストールされてなければグローバルのものが使用されます。

```lua :init.lua
use { "jose-elias-alvarez/null-ls.nvim", requires = { "nvim-lua/plenary.nvim" } }

local null_ls = require "null-ls"
null_ls.setup {
  sources = {
    null_ls.builtins.formatting.prettier.with {
      prefer_local = "node_modules/.bin",
    },
  },
}
```

発展的な設定例です。prettierの設定ファイルがあればprettierを使い、なければ代わりに`deno fmt`を使います。
```lua :init.lua
null_ls.setup {
  sources = {
    null_ls.builtins.formatting.deno_fmt.with {
      condition = function(utils)
        return not (utils.has_file { ".prettierrc", ".prettierrc.js", "deno.json", "deno.jsonc" })
      end,
    },
    null_ls.builtins.formatting.prettier.with {
      condition = function(utils)
        return utils.has_file { ".prettierrc", ".prettierrc.js" }
      end,
      prefer_local = "node_modules/.bin",
    },
  },
  capabilities = common_config.capabilities,
  on_attach = common_config.on_attach,
}
```


サーバーによってはそれ自体がフォーマット機能を持っているものがあります。それを無効化するには`on_attach`に

```lua
client.resolved_capabilities.document_formatting = false
```

を追加します。

:::message
`prettier`と同様に、`eslint`もnull-lsで使用できますが、すごく重いので、LSP版を使うことをお勧めします。nvim-lsp-installerからインストールできます。
:::


# いろいろなプラグイン達

ここまでで基本的な設定は完了ですが、LSP と連携して開発をより便利にしてくれるプラグインを紹介します。

## LSP 拡張系

- lspsaga.nvim

  https://github.com/tami5/lspsaga.nvim

  なんかいろいろリッチな表示になるプラグイン

- lsp_signature.nvim

  https://github.com/ray-x/lsp_signature.nvim

  関数の引数を入力しているときにシグネチャヘルプを表示してくれます。

- lspkind-nvim

  https://github.com/onsails/lspkind-nvim

  補完にアイコンを追加してくれるやつ

- trouble.nvim

  https://github.com/folke/trouble.nvim

  VSCode の下部に出るエラー一覧みたいなやつです。超便利。

## 特定の言語系

nvim-lsp を利用した特定の言語やフレームワーク向けのプラグインも開発され始めています。

- flutter-tools.nvim

  https://github.com/akinsho/flutter-tools.nvim

  neovim で flutter を使うなら前は coc 一択だったと思いますがこのプラグインがあれば coc じゃなくてもいいかなと思えるプラグインです。

- nvim-lsp-ts-utils

  https://github.com/jose-elias-alvarez/nvim-lsp-ts-utils

  ローカルの Prettier とか ESLint を使うとかできます。

- rust-tools.nvim

  https://github.com/simrat39/rust-tools.nvim

  Rust です

- go.nvim

  https://github.com/ray-x/go.nvim

  Go です

- nvim-jdtls

  https://github.com/mfussenegger/nvim-jdtls

  Java です

# 参考になるサイト

- 公式の LSP のドキュメント

  https://neovim.io/doc/user/lsp.html

- r/neovim

  https://www.reddit.com/r/neovim/

  海外の巨大掲示板 Reddit の neovim 板です。新しいプラグインはよくここで宣伝されています。他にもいろいろな neovim の最新情報を知ることができます。

- Githubのdotfilesリポジトリ達
  
  いろんな人が自分の好みのneovimのコンフィグを作ってGithubやらに上げています(Githubで`nvim`と検索すればたくさんでてきます)。参考になる設定が沢山あるので詰まったりしたら見てみるとよいでしょう。

# 最後に
この記事でやった設定ををまとめておきました。コメントとかも書き加えてあります。init.lua にこれを書いて起動するだけでセットアップされるようになっています。多分。
https://github.com/nazo6/zenn/blob/main/examples/c2f16b07798bab/init.lua

ついでに自分の neovim の設定のリポジトリを置いておきます。よければ参考にしてください。
https://github.com/nazo6/nvim

それではよい neovim ライフを。
