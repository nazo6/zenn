---
title: neovim luaのパフォーマンス計測方法
emoji: 🪟
type: idea
topics: [cpp, javascript, reactnative, react, typescript]
published: true
---

# やり方

[plenary.nvim の profiler](https://github.com/nvim-lua/plenary.nvim#plenaryprofile)を使います

plenary.nvim がインストールしてあれば使いかたは簡単で、計測したい範囲を

```lua
require'plenary.profile'.start("profile.log")

-- code to be profiled

require'plenary.profile'.stop()
```

のように囲むだけです。

これで init.lua であれば`~/.config/nvim`以下に profile.log ができます。

# グラフにする

が、このログは超絶見づらいので図にしたいです。そこで[inferno](https://github.com/jonhoo/inferno)という Rust 製ツールを使います。README にごちゃごちゃ書いてますが今回はログをグラフに変換したいだけなので cargo install するだけです。もちろん Rust ツールチェーンがインストールされている必要があります。

```
cargo install inferno
```

そしてさっきのプロファイルの開始の行を

```
require'plenary.profile'.start("profile.log", {flame = true})
```

に変えます。
そして

```
inferno-flamegraph profile.log > flame.svg
```

を実行すると svg で図が出力されます。

試しに自分の init.lua で試してみたのがこちらです。
![](https://storage.googleapis.com/zenn-user-upload/e23fe12b0c1c5f5cdfa01fdb.png)
どのプラグインに時間がかかっているのかが一目瞭然です。設定だけではなくプラグイン開発にも役立ちそうですね。

# `jit.vmdef not found` とかいうエラーがでた

LuaJIT をインストールします。

```
git clone https://github.com/LuaJIT/LuaJIT
cd LuaJIT
make
```

そして環境変数`LUA_PATH`に`今インストールしたLuaJITのパス/src`を追加します。
これで動くはずです。
